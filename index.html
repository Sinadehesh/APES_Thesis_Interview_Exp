<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interview Demo</title>
  <style>
    body { display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Verdana, sans-serif; background: #f0f2f5; }
    .container { width: 600px; max-width: 90vw; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
    .hidden { display: none; }
    input, button { width: 100%; padding: 12px; margin: 10px 0; font-size: 1em; }
    button { border: none; border-radius: 6px; cursor: pointer; background: #1976d2; color: #fff; }
    button:hover { background-color: #145a9e; }
    #startRecordingBtn { background: #d32f2f; }
    #startRecordingBtn:hover { background: #9a2424; }
    .status-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
    .video-prompt, #viewContainer img, .preview-video { width: 100%; border-radius: 6px; }
    .radio-group { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 20px 0; }
    .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; white-space: nowrap; }
  </style>
</head>
<body>
  <!-- STEP 1: Name & Job -->
  <div id="startPage" class="container">
    <h1>Welcome!</h1>
    <p>Please enter your name and the job you're interviewing for:</p>
    <input type="text" id="participantName" placeholder="Your name" />
    <input type="text" id="participantJob" placeholder="Desired job" />
    <button id="startIntroBtn">Next</button>
  </div>

  <!-- STEP 2: Personalized Intro -->
  <div id="introPage" class="container hidden">
    <h2>Hi <span id="displayName"></span>!</h2>
    <p>Imagine you're interviewing for the role of <strong><span id="displayJob"></span></strong>.</p>
    <p>This is a job you really want! So, do your best for this interview. You can even work remotely!</p>
    <p>After each batch of two questions, you'll answer a quick check-in.</p>
    <button id="startInterviewBtn">Start Interview</button>
  </div>

  <!-- INTERVIEW QUESTIONS -->
  <div id="interviewContainer" class="container hidden">
    <p id="questionDisplay"></p>
    <div id="viewContainer"></div>
    <p id="startInstruction">Click <strong>Start Recording</strong> when ready. You have 30s.</p>
    <button id="startRecordingBtn">Start Recording</button>
    <div class="status-row">
      <span id="redoDisplay">Redo: 0</span>
      <div id="recordIndicator" style="width:20px;height:20px;background:red;border-radius:50%;visibility:hidden;"></div>
      <span id="timerDisplay" style="color:red;visibility:hidden;">30</span>
    </div>
    <div style="display:flex;gap:10px;">
      <button id="redoBtn" style="flex:1;">Redo</button>
      <button id="finishBtn" style="flex:1;">Finish</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div id="previewPage" class="container hidden">
    <h2>Your Recording Preview</h2>
    <video id="previewVideo" class="preview-video" controls></video>
    <div style="display:flex;gap:10px;">
      <button id="previewRedoBtn" style="flex:1;">Redo</button>
      <button id="previewNextBtn" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- SHORT SURVEY (1 QUESTION AT A TIME) -->
  <div id="surveyContainer" class="container hidden">
    <h2>Quick Check-In</h2>
    <p id="surveyRoundIndicator"></p>
    <div id="currentQuestionContainer">
      <h3 id="currentQuestionText"></h3>
      <div id="currentQuestionOptions" class="radio-group"></div>
    </div>
    <div><small id="questionProgress"></small></div>
    <button id="nextSurveyBtn">Submit</button>
  </div>

  <!-- END -->
  <div id="endPage" class="container hidden">
    <h2>Thank You!</h2>
    <p>You've completed the interview. We appreciate your time!</p>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Your 3 post-condition questions ---
    const postConditionQuestions = [
      { id: "q1", text: "I felt anxious during this interview.", scale: ["Strongly disagree","Disagree","Neutral","Agree","Strongly agree"] },
      { id: "q2", text: "I was able to express myself clearly.", reverse: true, scale: ["Strongly disagree","Disagree","Neutral","Agree","Strongly agree"] },
      { id: "q3", text: "This format made it hard to show my abilities.", scale: ["Strongly disagree","Disagree","Neutral","Agree","Strongly agree"] }
    ];

    // --- Element refs ---
    const startPage       = document.getElementById('startPage'),
          introPage       = document.getElementById('introPage'),
          interviewPage   = document.getElementById('interviewContainer'),
          previewPage     = document.getElementById('previewPage'),
          surveyPage      = document.getElementById('surveyContainer'),
          endPage         = document.getElementById('endPage'),
          displayName     = document.getElementById('displayName'),
          displayJob      = document.getElementById('displayJob'),
          questionDisplay = document.getElementById('questionDisplay'),
          viewContainer   = document.getElementById('viewContainer'),
          startInstruction= document.getElementById('startInstruction'),
          redoDisplay     = document.getElementById('redoDisplay'),
          recordIndicator = document.getElementById('recordIndicator'),
          timerDisplay    = document.getElementById('timerDisplay'),
          previewVideo    = document.getElementById('previewVideo'),
          surveyForm      = document.getElementById('currentQuestionOptions'),
          currentQuestionText    = document.getElementById('currentQuestionText'),
          questionProgress       = document.getElementById('questionProgress'),
          surveyRoundIndicator   = document.getElementById('surveyRoundIndicator');

    const startIntroBtn    = document.getElementById('startIntroBtn'),
          startInterviewBtn= document.getElementById('startInterviewBtn'),
          startRecBtn      = document.getElementById('startRecordingBtn'),
          redoBtn          = document.getElementById('redoBtn'),
          finishBtn        = document.getElementById('finishBtn'),
          previewRedoBtn   = document.getElementById('previewRedoBtn'),
          previewNextBtn   = document.getElementById('previewNextBtn'),
          nextSurveyBtn    = document.getElementById('nextSurveyBtn');

    // --- Interview Data ---
    const questions      = ["Tell me about yourself.","What are your strengths?","What are your weaknesses?","Why do you want this job?","Describe a time you overcame a challenge.","Where do you see yourself in five years?"];
    const conditions     = [1,1,2,2,3,3]; // 1=mirror,2=video/avatar,3=blank
    const questionVideos = [null,null,"0729-1.mp4","0729-2.mp4",null,null];

    let currentIndex = 0, redoCounts = Array(questions.length).fill(0),
        mediaRecorder, recordedChunks = [], liveStream,
        surveyIndex = 0, surveyResponses = {};

    // STEP 1: Name & Job
    startIntroBtn.onclick = () => {
      const name = document.getElementById('participantName').value.trim();
      const job  = document.getElementById('participantJob').value.trim();
      if(!name||!job) return alert('Enter both name and job.');
      displayName.textContent = name;
      displayJob.textContent  = job;
      startPage.classList.add('hidden');
      introPage.classList.remove('hidden');
    };

    // STEP 2: Start Interview
    startInterviewBtn.onclick = () => {
      introPage.classList.add('hidden');
      interviewPage.classList.remove('hidden');
      showQuestion();
    };

    // Get camera + mic
    navigator.mediaDevices.getUserMedia({video:true,audio:true})
      .then(s=>liveStream=s)
      .catch(e=>{alert('Allow camera/mic'); console.error(e);});

    // Show next interview question
    function showQuestion(){
      // After every two, trigger survey
      if(currentIndex>0 && currentIndex%2===0){
        showSurvey();
        return;
      }
      // End?
      if(currentIndex>=questions.length){
        endPage.classList.remove('hidden');
        return;
      }
      // Normal question UI
      surveyPage.classList.add('hidden');
      previewPage.classList.add('hidden');
      interviewPage.classList.remove('hidden');
      endPage.classList.add('hidden');

      questionDisplay.textContent = questions[currentIndex];
      redoDisplay.textContent     = `Redo: ${redoCounts[currentIndex]}`;
      viewContainer.innerHTML     = '';
      startInstruction.style.display = 'block';
      startRecBtn.style.display      = 'inline-block';
      recordIndicator.style.visibility = 'hidden';
      timerDisplay.style.visibility    = 'hidden';

      if(conditions[currentIndex]===1 && liveStream){
        const vid=document.createElement('video');
        vid.srcObject=liveStream; vid.autoplay=vid.muted=vid.playsInline=true; vid.className='video-prompt';
        viewContainer.appendChild(vid);
      } else if(conditions[currentIndex]===2){
        const vid=document.createElement('video');
        vid.src=questionVideos[currentIndex]; vid.controls=vid.autoplay=true; vid.className='video-prompt';
        viewContainer.appendChild(vid);
      }
    }

    // Recording
    startRecBtn.onclick = () => {
      if(!liveStream) return alert('No camera.');
      recordedChunks=[]; mediaRecorder=new MediaRecorder(liveStream);
      mediaRecorder.ondataavailable=e=>e.data.size&&recordedChunks.push(e.data);
      mediaRecorder.onstop=()=>{
        previewVideo.src=URL.createObjectURL(new Blob(recordedChunks));
        interviewPage.classList.add('hidden');
        previewPage.classList.remove('hidden');
      };
      mediaRecorder.start();
      startInstruction.style.display='none';
      startRecBtn.style.display='none';
      recordIndicator.style.visibility='visible';
      timerDisplay.style.visibility='visible';
      if(conditions[currentIndex]===2){
        viewContainer.innerHTML='';
        const img=document.createElement('img'); img.src='input.jpg'; img.className='video-prompt';
        viewContainer.appendChild(img);
      }
      startTimer();
    };

    // Timer
    function startTimer(){
      let t=30; timerDisplay.textContent=t;
      timerDisplay._interval=setInterval(()=>{
        t--; timerDisplay.textContent=t;
        if(t<=0){clearInterval(timerDisplay._interval);mediaRecorder.stop();}
      },1000);
    }

    // Redo
    function redoQuestion(){
      if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();
      clearInterval(timerDisplay._interval);
      redoCounts[currentIndex]++;
      showQuestion();
    }
    redoBtn.onclick=redoQuestion;
    previewRedoBtn.onclick=redoQuestion;

    // Next
    finishBtn.onclick=()=>mediaRecorder&&mediaRecorder.stop();
    previewNextBtn.onclick=()=>{
      previewVideo.pause(); previewVideo.currentTime=0;
      if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();
      clearInterval(timerDisplay._interval);
      currentIndex++;
      showQuestion();
    };

    // SHOW SURVEY
    function showSurvey(){
      interviewPage.classList.add('hidden');
      previewPage.classList.add('hidden');
      surveyPage.classList.remove('hidden');
      surveyIndex=0;
      displayRound();
      renderSurveyQuestion();
    }
    function displayRound(){
      const cond = conditions[(currentIndex-1)];
      const name = cond===1?'Mirror':cond===2?'Avatar':'Text-only';
      surveyRoundIndicator.textContent = `After ${name} condition (Q${currentIndex-1}&${currentIndex})`;
    }

    // RENDER SURVEY Q
    function renderSurveyQuestion(){
      const q = postConditionQuestions[surveyIndex];
      currentQuestionText.textContent = q.text;
      questionProgress.textContent = `(${surveyIndex+1} of ${postConditionQuestions.length})`;
      surveyForm.innerHTML = '';
      q.scale.forEach((opt,i)=>{
        const lbl=document.createElement('label');
        lbl.innerHTML=`<input type="radio" name="surveyOption" value="${i+1}"> ${opt}`;
        surveyForm.appendChild(lbl);
      });
    }

    // SUBMIT SURVEY Q
    nextSurveyBtn.onclick = () => {
      const sel = document.querySelector('input[name="surveyOption"]:checked');
      if(!sel) return alert('Please choose an option.');
      // record
      surveyResponses[`${postConditionQuestions[surveyIndex].id}_c${Math.floor((currentIndex-1)/2)+1}`] = sel.value;
      surveyIndex++;
      if(surveyIndex < postConditionQuestions.length){
        renderSurveyQuestion();
      } else {
        surveyPage.classList.add('hidden');
        currentIndex++;
        showQuestion();
      }
    };

    // CLEANUP
    window.addEventListener('beforeunload',()=>{
      if(liveStream) liveStream.getTracks().forEach(t=>t.stop());
      if(timerDisplay._interval) clearInterval(timerDisplay._interval);
      console.log('Survey responses', surveyResponses);
    });
  });
  </script>
</body>
</html>
