<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interview Experience</title>
  <style>
    body { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      min-height: 100vh; 
      margin: 0; 
      font-family: 'Segoe UI', Tahoma, sans-serif; 
      background: #f0f2f5; 
    }
    .container { 
      width: 600px; 
      max-width: 90vw; 
      padding: 30px; 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
      text-align: center; 
    }
    .hidden { 
      display: none; 
    }
    input, button { 
      width: 100%; 
      padding: 12px; 
      margin: 10px 0; 
      font-size: 1em;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button { 
      border: none; 
      cursor: pointer; 
      background: #1976d2; 
      color: #fff;
      transition: background-color 0.2s;
    }
    button:hover { 
      background: #145a9e; 
    }
    #startRecordingBtn { 
      background: #d32f2f; 
    }
    #startRecordingBtn:hover { 
      background: #9a2424; 
    }
    .status-row { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 20px 0; 
    }
    .status-row span { 
      font-weight: bold; 
    }
    .video-prompt, #viewContainer img, .preview-video { 
      width: 100%; 
      border-radius: 6px; 
    }
    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      align-items: stretch;
    }
    .button-row button {
      flex: 1;
      margin: 0;
      min-width: 0;
      white-space: nowrap;
    }
    .radio-group { 
      display: flex; 
      flex-direction: row; 
      align-items: center; 
      margin: 20px 0;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .survey-option-btn {
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      color: #333;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s;
      white-space: nowrap;
      flex: 1;
      min-width: 0;
    }
    .survey-option-btn:hover {
      border-color: #1976d2;
      background: #f0f7ff;
    }
    .survey-option-btn.selected {
      background: #1976d2;
      color: white;
      border-color: #1976d2;
    }
  </style>
</head>
<body>
  <!-- STEP 1: Name & Job -->
  <div id="startPage" class="container">
    <h1>Welcome!</h1>
    <p>Enter your name, then enter the job title you hope to get:</p>
    <input type="text" id="participantName" placeholder="Your name" />
    <input type="text" id="participantJob" placeholder="Desired job" />
    <button id="startIntroBtn">Next</button>
  </div>

  <!-- STEP 2: Intro -->
  <div id="introPage" class="container hidden">
    <h2>Hi <span id="displayName"></span>!</h2>
    <p>You're about to participate in a research study designed to enhance and improve online interview experiences. You'll complete 3 different interview formats for a <strong><span id="displayJob"></span></strong> position, each with a unique setup.</p>
    <p>Please record yourself while answering the questions. If you're not satisfied with an answer, simply hit "Redo" to try again. You will be the ONLY person who sees the videos. Do your best!</p>
    <button id="startInterviewBtn">Start Interview</button>
  </div>

  <!-- INTERVIEW -->
  <div id="interviewPage" class="container hidden">
    <p id="questionText"></p>
    <div id="viewContainer"></div>
    <p id="recordInstruction">Click <strong>Start Recording</strong>. You have 30s.</p>
    <button id="startRecordingBtn">Start Recording</button>
    <div class="status-row">
      <span id="redoCount">Redo: 0</span>
      <div id="recordIndicator" style="width:20px;height:20px;background:red;border-radius:50%;visibility:hidden;"></div>
      <span id="timerDisplay" style="color:red;visibility:hidden;">30</span>
    </div>
    <div class="button-row">
      <button id="redoBtn">Redo</button>
      <button id="finishBtn">Finish</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div id="previewPage" class="container hidden">
    <h2>Your Recording</h2>
    <video id="previewVideo" class="preview-video" controls></video>
    <div class="button-row">
      <button id="previewRedoBtn">Redo</button>
      <button id="previewNextBtn">Next</button>
    </div>
  </div>

  <!-- SURVEY -->
  <div id="surveyPage" class="container hidden">
    <h2>Quick Check-In</h2>
    <p id="surveyRound"></p>
    <h3 id="surveyQuestion"></h3>
    <div id="surveyOptions" class="radio-group"></div>
    <button id="surveySubmitBtn">Submit</button>
    <p><small id="surveyProgress"></small></p>
  </div>

  <!-- END -->
  <div id="endPage" class="container hidden">
    <h2>Thank You!</h2>
    <p>You've completed the interview. We appreciate your time!</p>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Helper (accepts "id" or "#id")
    const $ = s => document.getElementById(s.startsWith('#') ? s.slice(1) : s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    // Post-condition survey (3 questions)
    const postQs = [
      { id:"q1", text:"While answering these two questions I felt anxious during this interview.", scale:["Strongly disagree","Disagree","Neutral","Agree","Strongly agree"] },
      { id:"q2", text:"While answering these two questions I was able to express myself clearly.", reverse:true, scale:["Strongly disagree","Disagree","Neutral","Agree","Strongly agree"] },
      { id:"q3", text:"While answering these two questions I felt I would be judged more negatively.", scale:["Strongly disagree","Disagree","Neutral","Agree","Strongly agree"] }
    ];

    // DOM refs
    const startPage = $('#startPage'), introPage = $('#introPage'),
          interviewPage = $('#interviewPage'), previewPage = $('#previewPage'),
          surveyPage = $('#surveyPage'), endPage = $('#endPage');

    const displayName = $('#displayName'), displayJob = $('#displayJob'),
          qText = $('#questionText'), viewContainer = $('#viewContainer'),
          recordInst = $('#recordInstruction'), redoCountSp = $('#redoCount'),
          recIndicator = $('#recordIndicator'), timerSp = $('#timerDisplay'),
          previewVideo = $('#previewVideo');

    const surveyRound = $('#surveyRound'), surveyQuestion = $('#surveyQuestion'),
          surveyOptions = $('#surveyOptions'), surveyProgress = $('#surveyProgress');

    const startIntroBtn = $('#startIntroBtn'), startInterviewBtn = $('#startInterviewBtn'),
          startRecBtn = $('#startRecordingBtn'), redoBtn = $('#redoBtn'),
          finishBtn = $('#finishBtn'), previewRedoBtn = $('#previewRedoBtn'),
          previewNextBtn = $('#previewNextBtn'), surveySubmitBtn = $('#surveySubmitBtn');

    // Interview data
    const Qs = [
      "Tell me about yourself.",                    // idx 0 (cond 1)
      "What are your strengths?",                   // idx 1 (cond 1)
      "— video prompt —",                           // idx 2 (cond 2) 0729-1.mp4
      "— video prompt —",                           // idx 3 (cond 2) 0729-2.mp4
      "Describe a time you overcame a challenge.",  // idx 4 (cond 3)
      "Where do you see yourself in five years?"    // idx 5 (cond 3)
    ];
    const conds    = [1,1,2,2,3,3];                 // 1=mirror, 2=avatar(video→picture), 3=blank/text
    const vidFiles = [null,null,"0729-1.mp4","0729-2.mp4",null,null];

    let idx = 0;
    let redoCounts = Array(Qs.length).fill(0);
    let stream = null, mediaRec = null, recChunks = [];
    let surveyIdx = 0, responses = {};

    // STEP 1
    startIntroBtn.onclick = () => {
      const name = $('participantName').value.trim();
      const job  = $('participantJob').value.trim();
      if (!name || !job) return alert("Enter both name & job.");
      displayName.textContent = name;
      displayJob.textContent  = job;
      hide(startPage); show(introPage);
    };

    // STEP 2
    startInterviewBtn.onclick = () => { 
      hide(introPage); 
      show(interviewPage); 
      showQuestion(); 
    };

    // Camera/mic
    navigator.mediaDevices.getUserMedia({ video:true, audio:true })
      .then(s => { stream = s; })
      .catch(() => alert("Camera/microphone access is required."));

    // Show a question or end
    function showQuestion() {
      if (idx >= Qs.length) { 
        hide(interviewPage); 
        show(endPage); 
        return; 
      }

      hide(previewPage); 
      show(interviewPage);

      // Hide text during avatar/video condition (video is the question)
      qText.textContent = (conds[idx] === 2) ? "" : Qs[idx];

      redoCountSp.textContent = `Redo: ${redoCounts[idx]}`;
      viewContainer.innerHTML = '';
      recordInst.style.display = 'block';
      startRecBtn.style.display = 'block';
      recIndicator.style.visibility = 'hidden';
      timerSp.style.visibility = 'hidden';

      if (conds[idx] === 1 && stream) {
        // Mirror: live webcam feed
        const v = document.createElement('video');
        v.srcObject = stream;
        v.autoplay = v.muted = v.playsInline = true;
        v.className = 'video-prompt';
        viewContainer.appendChild(v);
      } else if (conds[idx] === 2) {
        // Avatar: show the prompt video (no text)
        const v = document.createElement('video');
        v.src = vidFiles[idx];
        v.controls = v.autoplay = true;
        v.playsInline = true;
        v.className = 'video-prompt';
        viewContainer.appendChild(v);
      }
      // cond 3: text-only (leave viewContainer empty)
    }

    // Start recording
    startRecBtn.onclick = () => {
      if (!stream) return alert('No camera stream. Reload and allow access.');

      recChunks = [];
      mediaRec = new MediaRecorder(stream);
      mediaRec.ondataavailable = e => { 
        if (e.data && e.data.size) recChunks.push(e.data); 
      };
      mediaRec.onstop = () => {
        const blob = new Blob(recChunks, { type: 'video/webm' });
        previewVideo.src = URL.createObjectURL(blob);
        hide(interviewPage); 
        show(previewPage);
      };
      mediaRec.start();

      recordInst.style.display = 'none';
      startRecBtn.style.display = 'none';
      recIndicator.style.visibility = 'visible';
      timerSp.style.visibility = 'visible';

      // During avatar condition, swap the video out for the picture while they speak
      if (conds[idx] === 2) {
        viewContainer.innerHTML = '';
        const img = document.createElement('img');
        img.src = 'input.jpg';
        img.alt = '';
        img.className = 'video-prompt';
        viewContainer.appendChild(img);
      }

      startTimer();
    };

    // Countdown
    function startTimer() {
      let t = 30;
      timerSp.textContent = t;
      if (timerSp._timer) clearInterval(timerSp._timer);
      timerSp._timer = setInterval(() => {
        t--; 
        timerSp.textContent = t;
        if (t <= 0) {
          clearInterval(timerSp._timer);
          if (mediaRec && mediaRec.state !== 'inactive') mediaRec.stop();
        }
      }, 1000);
    }

    // Redo current question
    function doRedo() {
      if (mediaRec && mediaRec.state === 'recording') mediaRec.stop();
      if (timerSp._timer) clearInterval(timerSp._timer);
      redoCounts[idx]++;
      showQuestion();
    }
    redoBtn.onclick = doRedo;
    previewRedoBtn.onclick = doRedo;

    // Finish stops recording
    finishBtn.onclick = () => { 
      if (mediaRec && mediaRec.state === 'recording') mediaRec.stop(); 
    };

    // After preview → Next question
    previewNextBtn.onclick = () => {
      previewVideo.pause(); 
      previewVideo.currentTime = 0;
      if (mediaRec && mediaRec.state === 'recording') mediaRec.stop();
      if (timerSp._timer) clearInterval(timerSp._timer);
      idx++;  // advance to next question

      // Show survey ONLY after Q2 and Q4 (idx === 2 or 4). No survey-loop.
      if (idx === 2 || idx === 4) {
        showSurvey();
      } else {
        showQuestion(); // go directly to next question
      }
    };

    // Survey (triggered only from previewNextBtn for idx 2 and 4)
    function showSurvey() {
      hide(interviewPage); hide(previewPage); show(surveyPage);
      surveyIdx = 0;

      const lastCond = conds[idx - 1];
      const name = lastCond === 1 ? 'Mirror' : lastCond === 2 ? 'Avatar' : 'Text-only';
      surveyRound.textContent = `After ${name} segment`;

      renderSurvey();
    }

    function renderSurvey() {
      const q = postQs[surveyIdx];
      surveyQuestion.innerHTML = q.text; // Use innerHTML to render bold text
      surveyOptions.innerHTML = '';
      q.scale.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.className = 'survey-option-btn';
        btn.type = 'button';
        btn.dataset.value = i + 1;
        btn.onclick = () => {
          // Remove selected class from all buttons
          surveyOptions.querySelectorAll('.survey-option-btn').forEach(b => b.classList.remove('selected'));
          // Add selected class to clicked button
          btn.classList.add('selected');
        };
        surveyOptions.appendChild(btn);
      });
      surveyProgress.textContent = `${surveyIdx + 1} of ${postQs.length}`;
    }

    // Submit one survey item → advance or return to next question
    surveySubmitBtn.onclick = () => {
      const selectedBtn = surveyOptions.querySelector('.survey-option-btn.selected');
      if (!selectedBtn) return alert('Choose an option.');
      // You can store per-condition if needed:
      // responses[ postQs[surveyIdx].id + `_cond${Math.ceil(idx/2)}` ] = selectedBtn.dataset.value;

      surveyIdx++;
      if (surveyIdx < postQs.length) {
        renderSurvey();
      } else {
        // Do NOT change idx here; it already points at the next question (Q3 or Q5)
        hide(surveyPage);
        showQuestion();
      }
    };

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
      if (timerSp._timer) clearInterval(timerSp._timer);
    });
  });
  </script>
</body>
</html>
