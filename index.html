<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interview Demo</title>
  <style>
    body { display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Segoe UI', Tahoma, Verdana, sans-serif; background: #f0f2f5; }
    .container { width: 600px; max-width: 90vw; padding: 30px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
    .hidden { display: none; }
    input, button { width: 100%; padding: 12px; margin: 10px 0; font-size: 1em; }
    button { border: none; border-radius: 6px; cursor: pointer; background: #1976d2; color: #fff; }
    button:hover { background-color: #145a9e; }
    #startRecordingBtn { background: #d32f2f; }
    #startRecordingBtn:hover { background: #9a2424; }
    .status-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }
    .status-row > span { font-weight: bold; }
    .video-prompt, #viewContainer img { width: 100%; border-radius: 6px; }
    .preview-video { width: 100%; border-radius: 6px; }
    .radio-group label { display: block; text-align: left; margin: 8px 0; }
  </style>
</head>
<body>
  <!-- STEP 1: Name & Job -->
  <div id="startPage" class="container">
    <h1>Welcome!</h1>
    <p>Please enter your name and the job you're interviewing for:</p>
    <input type="text" id="participantName" placeholder="Your name" />
    <input type="text" id="participantJob" placeholder="Desired job" />
    <button id="startIntroBtn">Next</button>
  </div>

  <!-- STEP 2: Personalized Intro -->
  <div id="introPage" class="container hidden">
    <h2>Hi <span id="displayName"></span>!</h2>
    <p>Imagine you're interviewing for the role of <strong><span id="displayJob"></span></strong>.</p>
    <p>This is a job you really want! So, do your best for this interview. The salary is high and the company is amazing. You can even work remotely!</p>
    <p>After each batch of questions, you'll answer a few quick questions about how you felt.</p>
    <button id="startInterviewBtn">Start Interview</button>
  </div>

  <!-- INTERVIEW QUESTIONS -->
  <div id="interviewContainer" class="container hidden">
    <p id="questionDisplay"></p>
    <div id="viewContainer"></div>
    <p id="startInstruction">Click <strong>Start Recording</strong> when ready. You have 30s.</p>
    <button id="startRecordingBtn">Start Recording</button>
    <div class="status-row">
      <span id="redoDisplay">Redo: 0</span>
      <div id="recordIndicator" style="width:20px;height:20px;background:red;border-radius:50%;visibility:hidden;"></div>
      <span id="timerDisplay" style="color:red;visibility:hidden;">30</span>
    </div>
    <div style="display:flex; gap:10px;">
      <button id="redoBtn" style="flex:1;">Redo</button>
      <button id="finishBtn" style="flex:1;">Finish</button>
    </div>
  </div>

  <!-- PREVIEW -->
  <div id="previewPage" class="container hidden">
    <h2>Your Recording Preview</h2>
    <video id="previewVideo" class="preview-video" controls></video>
    <div style="display:flex; gap:10px;">
      <button id="previewRedoBtn" style="flex:1;">Redo</button>
      <button id="previewNextBtn" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- SHORT SURVEY (3 QUESTIONS) -->
  <div id="surveyContainer" class="container hidden">
    <h2>Quick Check-In</h2>
    <form id="surveyForm"></form>
    <button id="nextSurveyBtn">Submit</button>
  </div>

  <!-- END -->
  <div id="endPage" class="container hidden">
    <h2>Thank You!</h2>
    <p>You've completed the interview. We appreciate your time!</p>
  </div>

  <script>
    window.onload = () => {
      // --- Post-Condition Questions Array (Your 3 Questions) ---
      const postConditionQuestions = [
        {
          id: "q1",
          text: "I felt anxious during this interview.",
          scale: ["Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"]
        },
        {
          id: "q2",
          text: "I was able to express myself clearly.",
          reverse: true,
          scale: ["Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"]
        },
        {
          id: "q3",
          text: "This format made it hard to show my abilities.",
          scale: ["Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"]
        }
      ];

      // --- Elements ---
      const startPage        = document.getElementById('startPage'),
            introPage        = document.getElementById('introPage'),
            interviewPage    = document.getElementById('interviewContainer'),
            previewPage      = document.getElementById('previewPage'),
            surveyPage       = document.getElementById('surveyContainer'),
            endPage          = document.getElementById('endPage'),
            displayName      = document.getElementById('displayName'),
            displayJob       = document.getElementById('displayJob'),
            questionDisplay  = document.getElementById('questionDisplay'),
            viewContainer    = document.getElementById('viewContainer'),
            startInstruction = document.getElementById('startInstruction'),
            redoDisplay      = document.getElementById('redoDisplay'),
            recordIndicator  = document.getElementById('recordIndicator'),
            timerDisplay     = document.getElementById('timerDisplay'),
            previewVideo     = document.getElementById('previewVideo'),
            surveyForm       = document.getElementById('surveyForm');

      const startIntroBtn    = document.getElementById('startIntroBtn'),
            startInterviewBtn= document.getElementById('startInterviewBtn'),
            startRecBtn      = document.getElementById('startRecordingBtn'),
            redoBtn          = document.getElementById('redoBtn'),
            finishBtn        = document.getElementById('finishBtn'),
            previewRedoBtn   = document.getElementById('previewRedoBtn'),
            previewNextBtn   = document.getElementById('previewNextBtn'),
            nextSurveyBtn    = document.getElementById('nextSurveyBtn');

      // --- Interview Data ---
      const questions = [
        "Tell me about yourself.",
        "What are your strengths?",
        "What are your weaknesses?",
        "Why do you want this job?",
        "Describe a time you overcame a challenge.",
        "Where do you see yourself in five years?"
      ];
      const conditions = [1,1,2,2,3,3]; // 1: mirror, 2: video, 3: blank
      const questionVideos = [null, null, "0729-1.mp4", "0729-2.mp4", null, null];

      let currentIndex = 0,
          redoCounts   = Array(questions.length).fill(0),
          mediaRecorder, recordedChunks = [],
          liveStream, recordingTimer;

      // --- STEP 1: Name & Job ---
      startIntroBtn.onclick = () => {
        const name = document.getElementById('participantName').value.trim();
        const job  = document.getElementById('participantJob').value.trim();
        if (!name || !job) return alert('Please enter both your name and the job title.');
        displayName.textContent = name;
        displayJob.textContent  = job;
        startPage.classList.add('hidden');
        introPage.classList.remove('hidden');
      };

      // --- STEP 2: Start Interview ---
      startInterviewBtn.onclick = () => {
        introPage.classList.add('hidden');
        interviewPage.classList.remove('hidden');
        showQuestion();
      };

      // --- Get Media Stream ---
      navigator.mediaDevices.getUserMedia({ video:true, audio:true })
        .then(s => liveStream = s)
        .catch(err => {
          console.error('Error accessing media devices:', err);
          alert('Camera/microphone access is required for this interview demo.');
        });

      // --- Show Question Prompt ---
      function showQuestion() {
        if (currentIndex >= questions.length) {
          showSurvey();
          return;
        }

        previewPage.classList.add('hidden');
        surveyPage.classList.add('hidden');
        endPage.classList.add('hidden');
        interviewPage.classList.remove('hidden');

        viewContainer.innerHTML = '';
        questionDisplay.textContent = (conditions[currentIndex]===2) ? '' : questions[currentIndex];
        redoDisplay.textContent    = `Redo: ${redoCounts[currentIndex]}`;
        startInstruction.style.display = 'block';
        startRecBtn.style.display      = 'inline-block';
        recordIndicator.style.visibility = 'hidden';
        timerDisplay.style.visibility    = 'hidden';

        if (conditions[currentIndex] === 1 && liveStream) {
          const vid = document.createElement('video');
          vid.srcObject = liveStream;
          vid.autoplay = vid.muted = vid.playsInline = true;
          vid.className = 'video-prompt';
          viewContainer.appendChild(vid);

        } else if (conditions[currentIndex] === 2) {
          const vid = document.createElement('video');
          vid.src = questionVideos[currentIndex];
          vid.controls = vid.autoplay = true;
          vid.className = 'video-prompt';
          vid.onerror = () => console.warn(`Video file not found: ${questionVideos[currentIndex]}`);
          viewContainer.appendChild(vid);
        }
      }

      // --- Recording Logic ---
      startRecBtn.onclick = () => {
        if (!liveStream) {
          alert('Camera not available. Please refresh and allow camera access.');
          return;
        }

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(liveStream);
        
        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          previewVideo.src = URL.createObjectURL(blob);
          showPreview();
        };

        mediaRecorder.start();
        
        startInstruction.style.display = 'none';
        startRecBtn.style.display = 'none';
        recordIndicator.style.visibility = 'visible';
        timerDisplay.style.visibility = 'visible';
        
        let timeLeft = 30;
        recordingTimer = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = timeLeft;
          if (timeLeft <= 0) {
            clearInterval(recordingTimer);
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
              mediaRecorder.stop();
            }
          }
        }, 1000);
      };

      // --- Show Preview ---
      function showPreview() {
        interviewPage.classList.add('hidden');
        previewPage.classList.remove('hidden');
        recordIndicator.style.visibility = 'hidden';
        timerDisplay.style.visibility = 'hidden';
      }

      // --- Redo Current Question ---
      function redoQuestion() {
        redoCounts[currentIndex]++;
        if (recordingTimer) clearInterval(recordingTimer);
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        showQuestion();
      }

      redoBtn.onclick = redoQuestion;
      previewRedoBtn.onclick = redoQuestion;

      // --- Move to Next Question ---
      function nextQuestion() {
        currentIndex++;
        showQuestion();
      }

      finishBtn.onclick = nextQuestion;
      previewNextBtn.onclick = nextQuestion;

      // --- Show Survey ---
      function showSurvey() {
        interviewPage.classList.add('hidden');
        previewPage.classList.add('hidden');
        surveyPage.classList.remove('hidden');

        surveyForm.innerHTML = '';
        postConditionQuestions.forEach(q => {
          const fieldset = document.createElement('fieldset');
          fieldset.innerHTML = `<legend>${q.text}</legend>`;
          
          q.scale.forEach((option, i) => {
            const label = document.createElement('label');
            label.innerHTML = `
              <input type="radio" name="${q.id}" value="${i+1}" required>
              ${option}
            `;
            fieldset.appendChild(label);
          });
          
          surveyForm.appendChild(fieldset);
        });
      }

      // --- Submit Survey ---
      nextSurveyBtn.onclick = (e) => {
        e.preventDefault();
        const formData = new FormData(surveyForm);
        const responses = {};
        
        postConditionQuestions.forEach(q => {
          const value = formData.get(q.id);
          if (!value) {
            alert('Please answer all questions.');
            return;
          }
          responses[q.id] = parseInt(value);
        });

        if (Object.keys(responses).length === postConditionQuestions.length) {
          console.log('Survey responses:', responses);
          showEndPage();
        }
      };

      // --- Show End Page ---
      function showEndPage() {
        surveyPage.classList.add('hidden');
        endPage.classList.remove('hidden');
      }

      // --- Cleanup on page unload ---
      window.addEventListener('beforeunload', () => {
        if (liveStream) {
          liveStream.getTracks().forEach(track => track.stop());
        }
        if (recordingTimer) clearInterval(recordingTimer);
      });
    };
  </script>
</body>
</html>
